services:
  mysql:
      image: mysql:8.0
      container_name: mysql-container
      environment:
        MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
        MYSQL_DATABASE: ${DB_NAME}
        MYSQL_USER: ${DB_USER}
        MYSQL_PASSWORD: ${DB_PASSWORD}
      command: ["mysqld", "--default-authentication-plugin=mysql_native_password", "--character-set-server=utf8mb4", "--collation-server=utf8mb4_unicode_ci"]
      ports:
        - "3306:3306"
      volumes:
        - mysql_data:/var/lib/mysql
  minio:
      image: minio/minio:RELEASE.2022-01-04T07-41-07Z  # 稳定版本
      container_name: retainer_minio
      environment:
        MINIO_ROOT_USER: ${MINIO_ROOT_USER}
        MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
        # Web Console访问配置 - 从环境变量读取，支持灵活配置
        MINIO_BROWSER_REDIRECT_URL: ${MINIO_BROWSER_REDIRECT_URL}
        MINIO_SERVER_URL: ${MINIO_SERVER_URL}
      ports:
        - "9000:9000"
        - "9001:9001"
      volumes:
        - minio_data:/data
      command: server /data --console-address ":9001"
  app:
    build: ..
    container_name: test-container
    ports:
      - "3002:3002"
    depends_on:
      - mysql
      - minio
    volumes:
      - ../:/app
      - /app/node_modules  # 使用镜像中的 node_modules，不覆盖
    environment:
      PORT: "3002"
      NODE_ENV: ${NODE_ENV:-production}
      # MySQL 配置
      DB_HOST: ${DB_HOST:-39.97.36.219}
      DB_PORT: ${DB_PORT:-3306}
      DB_USER: ${DB_USER:-root}
      DB_PASSWORD: ${DB_PASSWORD:-KuranGames!}
      DB_NAME: ${DB_NAME:-card_games}
      # MinIO 配置
      MINIO_ENDPOINT: minio
      MINIO_PORT: "9000"
      MINIO_USE_SSL: "false"
      MINIO_PUBLIC_ENDPOINT: ${MINIO_PUBLIC_ENDPOINT:-localhost}
      MINIO_PUBLIC_PORT: ${MINIO_PUBLIC_PORT:-9000}
      MINIO_BUCKET_NAME: ${MINIO_BUCKET_NAME:-retainer-assets}
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      # JWT 配置
      JWT_SECRET: ${JWT_SECRET:-default_secret}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-default_refresh_secret}
      # LLM API 配置（从环境变量读取）
      CLAUDE_API_KEY: ${CLAUDE_API_KEY}
      CLAUDE_BASE_URL: ${CLAUDE_BASE_URL}
      ENABLE_LLM_PARSING: ${ENABLE_LLM_PARSING:-true}
      # 文件上传配置
      UPLOAD_DIR: uploads
      MAX_FILE_SIZE: ${MAX_FILE_SIZE:-10485760}
volumes:
  mysql_data:
  minio_data: